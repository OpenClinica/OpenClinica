<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-1">
		<comment>Create a new table called Tag for Monitoring Feature</comment>
		<createTable tableName="tag">
			<column autoIncrement="true" name="tag_id" type="int">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="tag_name" type="varchar(255)" />
		</createTable>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-2">
		<comment>Create a new table called Item_Data_Toolkit_Config for Monitoring Feature</comment>
		<createTable tableName="item_data_toolkit_config">
			<column autoIncrement="true" name="config_id" type="int">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="path" type="varchar(255)" />
			<column name="tag_id" type="int" />
			<column name="active" type="boolean" />
		</createTable>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-3">
		<comment>Create a new table called Entity_Flag for Monitoring Feature</comment>
		<createTable tableName="entity_flag">
			<column autoIncrement="true" name="entity_flag_id" type="int">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="entity_name" type="varchar(255)" />
			<column name="entity_id" type="int" />
			<column name="tag_status" type="varchar(255)" />
		</createTable>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-4">
		<comment>Insert a new record into Tag table</comment>
		<insert tableName="tag">
			<column name="tag_id" valueNumeric="1" />
			<column name="tag_name" value="SDV" />
		</insert>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-5">
		<comment>Create Views Item_Data_Toolkit</comment>
		<sql>
			-- View: view_item_data_toolkit

			-- DROP VIEW view_item_data_toolkit;

			CREATE OR REPLACE VIEW view_item_data_toolkit AS
			SELECT DISTINCT id.item_data_id,
			CASE
			WHEN s.parent_study_id IS NULL THEN 0
			ELSE s.parent_study_id
			END AS parent_study_id, s.study_id, ss.label AS study_subject_label,
			sed.name AS study_event_defn, sed.oc_oid AS sed_oid,
			se.sample_ordinal AS event_repeat_ordinal, c.name AS crf_name,
			c.oc_oid AS crf_oid, ig.name AS group_name, i.oc_oid AS i_oid,
			id.ordinal AS group_ordinal, ifm.left_item_text, id.value,
			ec.event_crf_id, ec.status_id AS event_crf_status_id
			FROM item_data id
			JOIN item i ON id.item_id = i.item_id
			JOIN item_form_metadata ifm ON ifm.item_id = i.item_id
			JOIN event_crf ec ON id.event_crf_id = ec.event_crf_id
			JOIN study_subject ss ON ss.study_subject_id = ec.study_subject_id
			JOIN study s ON s.study_id = ss.study_id
			JOIN crf_version cv ON ec.crf_version_id = cv.crf_version_id
			JOIN crf c ON c.crf_id = cv.crf_id
			JOIN item_group_metadata igm ON igm.item_id = id.item_id
			JOIN item_group ig ON ig.item_group_id = igm.item_group_id
			JOIN study_event se ON se.study_event_id = ec.study_event_id
			JOIN study_event_definition sed ON sed.study_event_definition_id =
			se.study_event_definition_id
			ORDER BY id.item_data_id;
		</sql>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-6">
		<comment>Create Views Item_Data_Toolkit_Filter1</comment>
		<sql>
			-- View: view_item_data_toolkit_filter1

			-- DROP VIEW view_item_data_toolkit_filter1;

			CREATE OR REPLACE VIEW view_item_data_toolkit_filter1 AS
			SELECT DISTINCT vm.item_data_id, vm.parent_study_id, vm.study_id,
			vm.study_subject_label, vm.study_event_defn, vm.sed_oid,
			vm.event_repeat_ordinal, vm.crf_name, vm.crf_oid, vm.group_name,
			vm.i_oid, vm.group_ordinal, vm.left_item_text, vm.value,
			vm.event_crf_id, vm.event_crf_status_id
			FROM view_item_data_toolkit vm, item_data_toolkit_config cg
			WHERE "substring"(cg.path::text, 0, ( SELECT "position"(cg.path::text,
			'.I_'::text) AS "position")) = ((vm.sed_oid::text || '.'::text) ||
			vm.crf_oid::text);

		</sql>
	</changeSet>

	<changeSet author="jkeremian" id="2016-01-26-OC-6963-7">
		<comment>Create Views Item_Data_Toolkit_Filter2</comment>
		<sql>
			-- View: view_item_data_toolkit_filter2

			-- DROP VIEW view_item_data_toolkit_filter2;

			CREATE OR REPLACE VIEW view_item_data_toolkit_filter2 AS
			SELECT DISTINCT c.path, view.item_data_id,
			view.parent_study_id, view.study_id, view.study_subject_label,
			view.study_event_defn, view.sed_oid, view.event_repeat_ordinal,
			view.crf_name, view.crf_oid, view.group_name, view.i_oid,
			view.group_ordinal, view.left_item_text, view.value,
			view.event_crf_id, view.event_crf_status_id,
			ef.entity_name, ef.tag_status
			FROM item_data_toolkit_config c
			RIGHT JOIN view_item_data_toolkit_filter1 view ON c.path::text =
			((((view.sed_oid::text || '.'::text) || view.crf_oid::text) ||
			'.'::text) || view.i_oid::text) AND c.active = true AND c.tag_id = 1
			LEFT JOIN entity_flag ef ON ef.entity_id = view.item_data_id AND
			ef.entity_name::text = 'item_data'::text;

		</sql>
	</changeSet>


</databaseChangeLog>